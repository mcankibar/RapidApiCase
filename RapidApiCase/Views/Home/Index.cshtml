@{
    ViewData["Title"] = "Hotel Booking - Home";
    Layout = "_Layout";
}
<style>
    .hotel-card {
        border: none;
        border-radius: 16px;
        overflow: hidden;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        position: relative;
    }

        .hotel-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .hotel-card .card-img-top {
            height: 200px;
            object-fit: cover;
            border-bottom: 1px solid #eee;
        }

        .hotel-card .card-body {
            padding: 20px;
            background-color: #fff;
            position: relative;
        }

        .hotel-card .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #333;
        }

        .hotel-card .card-text {
            font-size: 1.1rem;
            color: #333;
        }

    .price-badge {
        position: absolute;
        top: 10px;
        right: 10px;
        background-color: #007bff;
        color: #fff;
        padding: 8px 14px;
        font-weight: bold;
        border-radius: 20px;
        font-size: 0.95rem;
        box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }

    .review-badge {
        background-color: #28a745;
        color: white;
        font-size: 0.85rem;
        padding: 4px 10px;
        border-radius: 12px;
        display: inline-block;
        margin-bottom: 8px;
    }

    .stars {
        font-size: 1.2rem;
        color: #f5b301;
        margin-bottom: 8px;
        letter-spacing: 2px;
    }

    .rating-small {
        font-size: 0.9rem;
        color: #777;
    }

    .banner .carousel-indicators .active {
        background-color: #2563eb !important; /* veya #60a5fa */
    }
</style>
<!-- banner -->
<section id="home" class="banner_main">
    <div id="myCarousel" class="carousel slide banner" data-ride="carousel">
        <ol class="carousel-indicators">
            <li data-target="#myCarousel" data-slide-to="0" class="active"></li>
            <li data-target="#myCarousel" data-slide-to="1"></li>
            <li data-target="#myCarousel" data-slide-to="2"></li>
        </ol>
        <div class="carousel-inner">
            <div class="carousel-item active">
                <img class="first-slide" src="~/keto-1.0.0/keto-1.0.0/images/banner1.jpg" alt="First slide">
                <div class="container">
                </div>
            </div>
            <div class="carousel-item">
                <img class="second-slide" src="~/keto-1.0.0/keto-1.0.0/images/banner2.jpg" alt="Second slide">
            </div>
            <div class="carousel-item">
                <img class="third-slide" src="~/keto-1.0.0/keto-1.0.0/images/banner3.jpg" alt="Third slide">
            </div>
        </div>
        <a class="carousel-control-prev" href="#myCarousel" role="button" data-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="sr-only">Previous</span>
        </a>
        <a class="carousel-control-next" href="#myCarousel" role="button" data-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="sr-only">Next</span>
        </a>
    </div>
    <div class="booking_ocline">
        <div class="container">
            <div class="row">
                <div class="col-md-8">
                    <div class="book_room" style="border-left:#007bff">
                        <h1>Search and Book Hotels</h1>
                        <form class="book_now" method="get" id="hotelSearchForm">
                            <div class="row">
                                <div class="col-md-6">
                                    <span>City</span>
                                    <input class="online_book" name="city" type="text" placeholder="Enter city name (e.g. Istanbul)" required />
                                </div>
                                <div class="col-md-6">
                                    <span>Check-in Date</span>
                                    <img class="date_cua" src="~/keto-1.0.0/keto-1.0.0/images/date.png">
                                    <input class="online_book" type="date" name="checkin" id="checkin" required /> >
                                </div>
                                <div class="col-md-6">
                                    <span>Check-out Date</span>
                                    <img class="date_cua" src="~/keto-1.0.0/keto-1.0.0/images/date.png">
                                    <input class="online_book" type="date" name="checkout" id="checkout" required />
                                </div>
                                <div class="col-md-3">
                                    <span>Nmb of Adults</span>
                                    <input class="online_book" name="adults" type="number" min="1" max="10" value="2" />
                                </div>
                                <div class="col-md-3">
                                    <span>Nmb of Children</span>
                                    <input class="online_book" name="children" id="children" type="number" min="0" max="10" value="0" />
                                </div>
                                <div class="col-md-6" id="childrenAgesContainer" style="display: none;">
                                    <span>Children Ages (comma separated)</span>
                                    <input class="online_book" type="text" name="childrenAges" id="childrenAges" placeholder="E.g. 5,12" maxlength="20">
                                </div>
                                <div class="col-md-12">
                                    <button type="submit" class="book_btn">Search Hotels</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
<!-- end banner -->
<!-- filters -->
<div class="container mt-4">
    <div class="row">
        <div class="col-md-3">
            <label>Minimum Score</label>
            <select id="minScoreFilter" class="form-control">
                <option value="">All</option>
                <option value="9">9+</option>
                <option value="8">8+</option>
                <option value="7">7+</option>
            </select>
        </div>
        <div class="col-md-3">
            <label>Star Rating</label>
            <select id="starFilter" class="form-control">
                <option value="">All</option>
                <option value="5">5 Stars</option>
                <option value="4">4 Stars</option>
                <option value="3">3 Stars</option>
            </select>
        </div>
        <div class="col-md-3">
            <label>Max Price</label>
            <input type="number" id="maxPriceFilter" class="form-control" placeholder="E.g. 200">
        </div>
        <div class="col-md-3 d-flex align-items-end">
            <button onclick="applyFilters()" class="btn btn-outline-primary w-100">Filter</button>
        </div>
    </div>
   
</div>
<br/>
<!-- about -->
<div id="about" class="about">
    <div id="hotelListContainer" class="container-fluid">
        <!-- Hotel cards will be added here by JS -->
    </div>
</div>
<!-- end about -->

<script>
    let allHotels = [];

    document.getElementById("hotelSearchForm").addEventListener("submit", async function (e) {
        e.preventDefault();

        const formData = new FormData(this);
        const params = new URLSearchParams(formData).toString();

        const arrivalDate = formData.get("checkin");
        const departureDate = formData.get("checkout");
        const adults = formData.get("adults");
        const childrenAges = formData.get("childrenAges") || "";
        const roomQty = 1; // Default value
        const languageCode = "en-us";
        const currencyCode = "EUR";

        const hotelListContainer = document.getElementById("hotelListContainer");
        hotelListContainer.innerHTML = "<p>Searching...</p>";

        try {
            const res = await fetch(`/Hotel/SearchHotel?${params}`);
            const text = await res.text();
            let data;

            try {
                data = JSON.parse(text);
            } catch (err) {
                hotelListContainer.innerHTML = "<p>Unexpected error: Non-JSON response from server.</p>";
                return;
            }

            if (data.error) {
                hotelListContainer.innerHTML = `<p>Error: ${data.message}</p>`;
                return;
            }

            if (data.length === 0) {
                hotelListContainer.innerHTML = "<p>No hotels found.</p>";
                return;
            }

            allHotels = data;
            renderHotels(allHotels, arrivalDate, departureDate, adults, childrenAges, roomQty, languageCode, currencyCode);
        } catch (error) {
            hotelListContainer.innerHTML = `<p>Error during request: ${error.message}</p>`;
        }
    });

    function applyFilters() {
        const minScore = parseFloat(document.getElementById("minScoreFilter").value) || 0;
        const stars = parseInt(document.getElementById("starFilter").value) || 0;
        const maxPrice = parseFloat(document.getElementById("maxPriceFilter").value) || Infinity;

        const filtered = allHotels.filter(h =>
            h.reviewScore >= minScore &&
            (stars === 0 || h.stars === stars) &&
            h.price <= maxPrice
        );

        renderHotels(filtered);
    }

    function renderHotels(hotels, arrivalDate, departureDate, adults, childrenAges, roomQty, languageCode, currencyCode) {
        const container = document.getElementById("hotelListContainer");

        let html = '<div class="row">';

        hotels.forEach((hotel, index) => {

            const stars = "★".repeat(hotel.stars || 0) + "☆".repeat(5 - (hotel.stars || 0));
            const isDiscounted = hotel.originalPrice && hotel.price && hotel.originalPrice > hotel.price;

            const discountLabel = isDiscounted
                ? `<span class="badge badge-danger position-absolute" style="top: 10px; left: 10px;">Discount!</span>`
                : '';

            const preferredLabel = hotel.isPreferredPlus
                ? `<span class="badge badge-warning position-absolute" style="top: 10px; left: 90px;">Preferred+</span>`
                : hotel.isPreferred
                    ? `<span class="badge badge-secondary position-absolute" style="top: 10px; left: 90px;">Preferred</span>`
                    : '';

            const benefitBadgesHtml = Array.isArray(hotel.benefitBadges)
                ? hotel.benefitBadges.map(b =>
                    `<span class="badge badge-success mr-1">${b}</span>`
                  ).join(" ")
                : "";

            const shortAccessibility = hotel.accessibilityLabel?.length > 100
                ? hotel.accessibilityLabel.slice(0, 100) + "..."
                : hotel.accessibilityLabel || "";

            html += `
                <div class="col-md-4 mb-5">
                    <div class="card hotel-card h-100 position-relative shadow-sm" style="cursor:pointer;"
                    onclick="window.location='/Hotel/Detail?hotelId=${hotel.hotelId}&arrivalDate=${arrivalDate}&departureDate=${departureDate}&adults=${adults}&childrenAges=${encodeURIComponent(childrenAges)}&roomQty=${roomQty}&languageCode=${languageCode}&currencyCode=${currencyCode}&accessibilityLabel=${encodeURIComponent(hotel.accessibilityLabel || '')}&isPreferred=${!!hotel.isPreferred ? 1 : 0}&isPreferredPlus=${!!hotel.isPreferredPlus ? 1 : 0}&isDiscounted=${!!isDiscounted ? 1 : 0}'">
                        ${discountLabel}
                        ${preferredLabel}
                        <img src="${hotel.imageUrl || '#'}" class="card-img-top" alt="${hotel.name || 'Hotel'}">
                        <div class="price-badge">
                            ${
                                isDiscounted
                                ? `<del style="font-size: 0.85rem; opacity: 0.7;">${hotel.originalPrice?.toFixed?.(0)} ${hotel.currency || ''}</del><br>
                                   <strong>${hotel.price?.toFixed?.(0)} ${hotel.currency || ''}</strong>`
                                : `<strong>${hotel.price?.toFixed?.(0)} ${hotel.currency || ''}</strong>`
                            }
                        </div>
                        <div class="card-body">
                            <h5 class="card-title">${hotel.name || 'Hotel'}</h5>
                            <div class="review-badge">
                                ⭐ ${hotel.reviewScore?.toFixed?.(1) || '?'} ${hotel.reviewText || ''}
                            </div>
                            <div class="rating-small">(${hotel.reviewCount || '?'} reviews)</div>
                            <div class="stars" style="letter-spacing: 2px; color: #f5b301;">${stars}</div>
                            <p class="card-text mt-2">
                                <i class="fa fa-map-marker-alt mr-1 text-danger"></i>
                                ${hotel.city || 'No location'} (${hotel.countryCode?.toUpperCase() || ''})
                            </p>
                            <p class="card-text">
                                <small class="text-muted">
                                    Check-in: ${hotel.checkinTimeFrom || "-"} - ${hotel.checkinTimeUntil || "-"} /
                                    Check-out: ${hotel.checkoutTimeFrom || "-"} - ${hotel.checkoutTimeUntil || "-"}
                                </small><br>
                                <small class="text-muted">
                                    Dates: ${hotel.checkinDate || "-"} → ${hotel.checkoutDate || "-"}
                                </small>
                            </p>
                            <p class="card-text" style="font-size:0.9rem; color:#555; margin-top:0.75rem;">
                                ${shortAccessibility}
                            </p>
                            ${benefitBadgesHtml}
                        </div>
                    </div>
                </div>
            `;
        });

        html += '</div>';
        container.innerHTML = html;
    }
</script>